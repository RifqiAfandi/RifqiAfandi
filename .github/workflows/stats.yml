name: Generate GitHub Stats

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight UTC
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate Stats
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get user data
            const { data: user } = await github.rest.users.getByUsername({
              username: 'RifqiAfandi'
            });
            
            // Get repos
            const { data: repos } = await github.rest.repos.listForUser({
              username: 'RifqiAfandi',
              per_page: 100
            });
            
            // Calculate language stats
            const langCount = {};
            let totalRepos = 0;
            
            for (const repo of repos) {
              if (repo.language && !repo.fork) {
                langCount[repo.language] = (langCount[repo.language] || 0) + 1;
                totalRepos++;
              }
            }
            
            // Sort languages by count
            const sortedLangs = Object.entries(langCount)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5);
            
            // Language colors
            const langColors = {
              'JavaScript': '#f1e05a',
              'Python': '#3572A5',
              'HTML': '#e34c26',
              'CSS': '#563d7c',
              'TypeScript': '#3178c6',
              'Java': '#b07219',
              'PHP': '#4F5D95',
              'C++': '#f34b7d',
              'C': '#555555',
              'Shell': '#89e051'
            };
            
            // Generate languages SVG
            let langBars = '';
            let yPos = 40;
            
            for (const [lang, count] of sortedLangs) {
              const percentage = Math.round((count / totalRepos) * 100);
              const barWidth = Math.round((percentage / 100) * 268);
              const color = langColors[lang] || '#8b949e';
              
              langBars += `
              <g transform="translate(16, ${yPos})">
                <rect width="268" height="8" rx="4" fill="#21262d"/>
                <rect width="${barWidth}" height="8" rx="4" fill="${color}"/>
                <text x="0" y="22" fill="#c9d1d9" font-family="Segoe UI, Arial, sans-serif" font-size="11">${lang}</text>
                <text x="268" y="22" fill="#8b949e" font-family="Segoe UI, Arial, sans-serif" font-size="11" text-anchor="end">${percentage}%</text>
              </g>`;
              yPos += 30;
            }
            
            const langSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="300" height="${yPos + 10}" viewBox="0 0 300 ${yPos + 10}">
              <defs>
                <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#161b22;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#0d1117;stop-opacity:1" />
                </linearGradient>
              </defs>
              <rect width="300" height="${yPos + 10}" rx="8" fill="url(#bgGrad)" stroke="#30363d" stroke-width="1"/>
              <text x="150" y="24" fill="#58a6ff" font-family="Segoe UI, Arial, sans-serif" font-size="13" font-weight="600" text-anchor="middle">Top Languages</text>
              ${langBars}
            </svg>`;
            
            // Get contribution data via GraphQL
            const query = `
              query($username: String!) {
                user(login: $username) {
                  contributionsCollection {
                    contributionCalendar {
                      totalContributions
                      weeks {
                        contributionDays {
                          contributionCount
                          date
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const { user: userData } = await github.graphql(query, { username: 'RifqiAfandi' });
            const calendar = userData.contributionsCollection.contributionCalendar;
            const totalContributions = calendar.totalContributions;
            
            // Calculate streaks
            const allDays = calendar.weeks.flatMap(w => w.contributionDays).reverse();
            
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;
            let streakStart = '';
            let streakEnd = '';
            let longestStart = '';
            let longestEnd = '';
            
            // Current streak (from today backwards)
            const today = new Date().toISOString().split('T')[0];
            for (const day of allDays) {
              if (day.contributionCount > 0) {
                if (currentStreak === 0) streakEnd = day.date;
                currentStreak++;
                streakStart = day.date;
              } else if (currentStreak > 0) {
                break;
              }
            }
            
            // Longest streak
            for (const day of [...allDays].reverse()) {
              if (day.contributionCount > 0) {
                if (tempStreak === 0) longestStart = day.date;
                tempStreak++;
                longestEnd = day.date;
                if (tempStreak > longestStreak) {
                  longestStreak = tempStreak;
                }
              } else {
                tempStreak = 0;
              }
            }
            
            // Format dates
            const formatDate = (dateStr) => {
              if (!dateStr) return '';
              const date = new Date(dateStr);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            };
            
            const yearAgo = new Date();
            yearAgo.setFullYear(yearAgo.getFullYear() - 1);
            const dateRange = `${formatDate(yearAgo.toISOString())} - ${formatDate(today)}`;
            
            // Week activity (last 7 days)
            const last7Days = allDays.slice(0, 7).reverse();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let weekBars = '';
            let xPos = 0;
            
            for (let i = 0; i < 7; i++) {
              const day = last7Days[i] || { contributionCount: 0 };
              const count = day.contributionCount;
              let bgColor, textColor;
              
              if (count === 0) {
                bgColor = '#161b22';
                textColor = '#484f58';
              } else if (count <= 2) {
                bgColor = '#0e4429';
                textColor = '#3fb950';
              } else if (count <= 5) {
                bgColor = '#26a641';
                textColor = '#ffffff';
              } else {
                bgColor = '#39d353';
                textColor = '#0d1117';
              }
              
              const stroke = count === 0 ? ' stroke="#21262d" stroke-width="1"' : '';
              
              weekBars += `
                <rect x="${xPos}" y="0" width="50" height="45" rx="6" fill="${bgColor}"${stroke}/>
                <text x="${xPos + 25}" y="28" fill="${textColor}" font-family="Segoe UI, Arial, sans-serif" font-size="11" font-weight="500" text-anchor="middle">${dayNames[(new Date(day.date || today).getDay())]}</text>
              `;
              xPos += 54;
            }
            
            const streakSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="160" viewBox="0 0 400 160">
              <defs>
                <linearGradient id="streakBg" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#161b22;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#0d1117;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="fireGrad" x1="0%" y1="100%" x2="0%" y2="0%">
                  <stop offset="0%" style="stop-color:#ff6b35" />
                  <stop offset="50%" style="stop-color:#f7931a" />
                  <stop offset="100%" style="stop-color:#ffd700" />
                </linearGradient>
              </defs>
              <rect width="400" height="160" rx="8" fill="url(#streakBg)" stroke="#30363d" stroke-width="1"/>
              
              <g transform="translate(20, 18)">
                <text x="50" y="14" fill="#8b949e" font-family="Segoe UI, Arial, sans-serif" font-size="11" text-anchor="middle">Total Contributions</text>
                <text x="50" y="52" fill="#c9d1d9" font-family="Segoe UI, Arial, sans-serif" font-size="32" font-weight="bold" text-anchor="middle">${totalContributions}</text>
                <text x="50" y="70" fill="#6e7681" font-family="Segoe UI, Arial, sans-serif" font-size="9" text-anchor="middle">${dateRange}</text>
              </g>
              
              <line x1="133" y1="18" x2="133" y2="88" stroke="#30363d" stroke-width="1"/>
              
              <g transform="translate(133, 18)">
                <text x="67" y="14" fill="#8b949e" font-family="Segoe UI, Arial, sans-serif" font-size="11" text-anchor="middle">Current Streak</text>
                <g transform="translate(55, 20)">
                  <path d="M12,2 C12,2 8,8 8,12 C8,15.5 10,18 12,20 C14,18 16,15.5 16,12 C16,8 12,2 12,2 Z" fill="url(#fireGrad)" transform="scale(1.2)"/>
                </g>
                <text x="67" y="65" fill="#f7931a" font-family="Segoe UI, Arial, sans-serif" font-size="26" font-weight="bold" text-anchor="middle">${currentStreak}</text>
                <text x="67" y="80" fill="#6e7681" font-family="Segoe UI, Arial, sans-serif" font-size="9" text-anchor="middle">${formatDate(streakStart)} - ${formatDate(streakEnd)}</text>
              </g>
              
              <line x1="267" y1="18" x2="267" y2="88" stroke="#30363d" stroke-width="1"/>
              
              <g transform="translate(267, 18)">
                <text x="67" y="14" fill="#8b949e" font-family="Segoe UI, Arial, sans-serif" font-size="11" text-anchor="middle">Longest Streak</text>
                <text x="67" y="52" fill="#c9d1d9" font-family="Segoe UI, Arial, sans-serif" font-size="32" font-weight="bold" text-anchor="middle">${longestStreak}</text>
                <text x="67" y="70" fill="#6e7681" font-family="Segoe UI, Arial, sans-serif" font-size="9" text-anchor="middle">${formatDate(longestStart)} - ${formatDate(longestEnd)}</text>
              </g>
              
              <g transform="translate(22, 100)">
                ${weekBars}
              </g>
            </svg>`;
            
            // Ensure assets directory exists
            if (!fs.existsSync('assets')) {
              fs.mkdirSync('assets');
            }
            
            // Write SVG files
            fs.writeFileSync('assets/languages.svg', langSvg.trim());
            fs.writeFileSync('assets/streak.svg', streakSvg.trim());
            
            console.log('Stats generated successfully!');
            console.log(`Total contributions: ${totalContributions}`);
            console.log(`Current streak: ${currentStreak}`);
            console.log(`Longest streak: ${longestStreak}`);
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add assets/
          git diff --staged --quiet || git commit -m "ðŸ“Š Update GitHub stats"
          git push
